# Deploy & Environment Guide

This project is prepared to run in multiple environments (local, staging, production).

## 1. Environment configuration

The application loads `.env` files in the following precedence (where `NODE_ENV` defaults to `development`):

1. `.env.<NODE_ENV>.local`
2. `.env.<NODE_ENV>`
3. `.env.local`
4. `.env`
5. `.env.secrets`

Use `.env.example` as a template for required variables. Copy it per environment:

```bash
cp .env.example .env.development.local   # local dev
echo "NODE_ENV=staging" > .env.staging    # staging (fill rest)
```

Override values (database credentials, JWT secret, etc.) inside each file.

### Key variables

| Variable | Description |
| --- | --- |
| `SERVICE_HOST`, `SERVICE_PORT` | HTTP binding |
| `JWT_SECRET`, `JWT_EXPIRATION` | Token configuration |
| `HASH_SALT` | bcrypt salt rounds |
| `FILES_PATH`, `FILES_UPLOAD_FOLDER` | Base folder for uploads |
| `MYSQL_*` | Database connection parameters |
| `MYSQL_SSL` | Enable TLS connection (`true`/`false`) |
| `TYPEORM_SYNCHRONIZE` | Set to `true` only in disposable dev environments |
| `TYPEORM_RUN_MIGRATIONS` | Auto-run migrations on bootstrap |

## 2. Database migrations & seeds

TypeORM CLI reads `ormconfig.ts`, which now honours the same env files. Typical commands:

```bash
# after modifying entities, create a migration
npm run migration:create -- --name AddNewTable
npm run typeorm -- migration:generate src/migrations/$(date +%s)-AutoGenerated

# apply migrations
NODE_ENV=development npm run migration:run
NODE_ENV=staging npm run migration:run
NODE_ENV=production npm run migration:run

# revert last migration
NODE_ENV=staging npm run migration:revert

# run seeds (customise in src/seeds)
NODE_ENV=development npm run seed:run
```

> The main seeder (`src/seeds/index.ts`) empties tables in dependency order (`transaction_file`, `transaction`, `animal_file`, `animal`, `notification`, `user`, `company`) before inserting the demo records. Run it only on disposable/dev databases because it wipes existing data. If the database already exists from `synchronize`, generate an initial migration to capture the baseline schema before turning `TYPEORM_SYNCHRONIZE` off in shared environments.

## 3. Deployment workflow

1. Provide the correct `.env.<NODE_ENV>` file on the server or inject variables via your orchestrator (Docker/Kubernetes/CI).
2. Install dependencies and build:
   ```bash
   npm ci
   npm run build
   ```
3. Apply database migrations:
   ```bash
   NODE_ENV=<env> npm run migration:run
   ```
4. Optionally seed demo data (non-production environments):
   ```bash
   NODE_ENV=<env> npm run seed:run
   ```
   This command will delete data from the tables listed above prior to inserting the baseline records; avoid running it against live data sets.
5. Start the service:
   ```bash
   NODE_ENV=<env> npm run start:prod
   ```

## 4. CI/CD notes

- Before deploying, run linters/tests/build locally or in CI: `npm run lint`, `npm test`, `npm run build`.
- Deployment pipeline steps:
  1. Export environment variables or provide the matching `.env.<NODE_ENV>` file.
  2. `npm ci`
  3. `npm run build`
  4. `NODE_ENV=<env> npm run migration:run`
  5. Restart the process manager (PM2/systemd/Docker).
- For rollback, execute `NODE_ENV=<env> npm run migration:revert` and redeploy the previous artifact.

Keep `TYPEORM_SYNCHRONIZE=false` in staging/production to ensure schema changes happen exclusively through migrations.
